name: Ralph CI/CD Pipeline

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]
  workflow_dispatch:

jobs:
  # ============================================
  # STATIC ANALYSIS
  # ============================================
  shellcheck:
    name: ShellCheck Static Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run ShellCheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: '.'
          severity: warning
          ignore_paths: tests/test-output* .git

  # ============================================
  # UNIT TESTS
  # ============================================
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        bash-version: ['4.4', '5.0', '5.1', '5.2']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Bash ${{ matrix.bash-version }}
        run: |
          # Use system bash (Ubuntu latest has bash 5.x)
          bash --version

      - name: Make tests executable
        run: chmod +x tests/*.sh

      - name: Run unit tests
        run: |
          cd tests
          ./run-all-tests.sh --unit-only --verbose
        continue-on-error: false

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: unit-test-results-bash-${{ matrix.bash-version }}
          path: tests/test-output*/
          retention-days: 7

  # ============================================
  # INTEGRATION TESTS
  # ============================================
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: unit-tests
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Make tests executable
        run: chmod +x tests/*.sh

      - name: Run integration tests
        run: |
          cd tests
          ./run-all-tests.sh --integration-only --verbose

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: integration-test-results
          path: tests/test-output*/
          retention-days: 7

  # ============================================
  # SECURITY TESTS
  # ============================================
  security-tests:
    name: Security Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Make tests executable
        run: chmod +x tests/*.sh

      - name: Run security tests
        run: |
          cd tests
          ./run-all-tests.sh --security-only --verbose

      - name: Upload security test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: security-test-results
          path: tests/test-output*/
          retention-days: 30

  # ============================================
  # COMPATIBILITY TESTS
  # ============================================
  compatibility:
    name: OS Compatibility
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, ubuntu-20.04, ubuntu-22.04, macos-latest, macos-12]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check bash version
        run: bash --version

      - name: Make scripts executable
        run: |
          chmod +x *.sh
          chmod +x tests/*.sh

      - name: Test installation
        run: |
          # Test that scripts can be sourced without errors
          bash -n ralph.sh
          bash -n notify.sh
          bash -n setup-notifications.sh
          bash -n install.sh
          bash -n update.sh

      - name: Run compatibility tests
        run: |
          cd tests
          ./run-all-tests.sh --verbose
        continue-on-error: ${{ matrix.os == 'macos-latest' || matrix.os == 'macos-12' }}

  # ============================================
  # DEPENDENCY CHECK
  # ============================================
  dependencies:
    name: Dependency Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check required dependencies
        run: |
          echo "Checking for required tools..."
          command -v bash || exit 1
          command -v git || exit 1
          command -v curl || exit 1

          echo "Checking for optional tools..."
          command -v jq || echo "jq not installed (optional)"
          command -v shellcheck || echo "shellcheck not installed (optional)"

          echo "All required dependencies available"

  # ============================================
  # CODE COVERAGE (Mock)
  # ============================================
  coverage:
    name: Test Coverage Report
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Make tests executable
        run: chmod +x tests/*.sh

      - name: Run all tests
        run: |
          cd tests
          ./run-all-tests.sh --verbose > test-results.txt 2>&1 || true

      - name: Generate coverage summary
        run: |
          echo "# Test Coverage Summary" > coverage-summary.md
          echo "" >> coverage-summary.md
          echo "Generated on: $(date)" >> coverage-summary.md
          echo "" >> coverage-summary.md

          # Extract test statistics
          if [ -f tests/test-results.txt ]; then
            grep -A 10 "Test Summary" tests/test-results.txt >> coverage-summary.md || true
          fi

          echo "" >> coverage-summary.md
          echo "## Test Files" >> coverage-summary.md
          echo "" >> coverage-summary.md
          find tests -name "test-*.sh" -exec basename {} \; | sed 's/^/- /' >> coverage-summary.md

      - name: Upload coverage report
        uses: actions/upload-artifact@v3
        with:
          name: coverage-summary
          path: coverage-summary.md
          retention-days: 30

  # ============================================
  # NOTIFICATION (Optional)
  # ============================================
  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [shellcheck, unit-tests, integration-tests, security-tests, compatibility]
    if: always()
    steps:
      - name: Check job status
        run: |
          echo "ShellCheck: ${{ needs.shellcheck.result }}"
          echo "Unit Tests: ${{ needs.unit-tests.result }}"
          echo "Integration Tests: ${{ needs.integration-tests.result }}"
          echo "Security Tests: ${{ needs.security-tests.result }}"
          echo "Compatibility: ${{ needs.compatibility.result }}"

      - name: Determine overall status
        id: status
        run: |
          if [[ "${{ needs.shellcheck.result }}" == "success" ]] && \
             [[ "${{ needs.unit-tests.result }}" == "success" ]] && \
             [[ "${{ needs.integration-tests.result }}" == "success" ]] && \
             [[ "${{ needs.security-tests.result }}" == "success" ]]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "All tests passed!"
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "Some tests failed."
          fi

  # ============================================
  # RELEASE (On Tag)
  # ============================================
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [shellcheck, unit-tests, integration-tests, security-tests]
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create release notes
        run: |
          echo "# Ralph v${{ steps.version.outputs.version }}" > release-notes.md
          echo "" >> release-notes.md
          echo "## Changes" >> release-notes.md
          echo "" >> release-notes.md

          # Extract from CHANGELOG if it exists
          if [ -f CHANGELOG.md ]; then
            sed -n "/## \[v\?${{ steps.version.outputs.version }}\]/,/## \[v\?[0-9]/p" CHANGELOG.md | head -n -1 >> release-notes.md
          fi

          echo "" >> release-notes.md
          echo "## Test Results" >> release-notes.md
          echo "- ✅ All tests passed" >> release-notes.md
          echo "- ✅ ShellCheck: passed" >> release-notes.md
          echo "- ✅ Security tests: passed" >> release-notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          body_path: release-notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
